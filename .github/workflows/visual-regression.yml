name: Visual Regression Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'pnpm'

    - name: Install dependencies
      run: |
        if [ -f "pnpm-lock.yaml" ]; then
          echo "Found pnpm-lock.yaml, attempting frozen install..."
          pnpm install --frozen-lockfile || {
            echo "Frozen install failed, falling back to regular install..."
            pnpm install
          }
        else
          echo "No pnpm-lock.yaml found, running regular install..."
          pnpm install
        fi

    - name: Run Visual Regression Tests
      run: pnpm test -- --testNamePattern="Visual Regression Tests" --watchAll=false --verbose
      env:
        NODE_ENV: test
        CI: true

    - name: Check for Snapshot Changes
      id: snapshot-check
      run: |
        if git diff --name-only | grep -q "__snapshots__"; then
          echo "snapshot-changes=true" >> $GITHUB_OUTPUT
          echo "📸 Snapshot changes detected!"
          git diff --name-only | grep "__snapshots__"
        else
          echo "snapshot-changes=false" >> $GITHUB_OUTPUT
          echo "✅ No snapshot changes"
        fi

    - name: Upload Snapshot Artifacts
      if: steps.snapshot-check.outputs.snapshot-changes == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: updated-snapshots
        path: '**/__snapshots__/'
        retention-days: 7

    - name: Comment on PR with Snapshot Changes
      if: github.event_name == 'pull_request' && steps.snapshot-check.outputs.snapshot-changes == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `📸 **Visual Regression Test Alert**
            
            This PR contains snapshot changes. Please review the visual changes carefully:
            
            1. Check the uploaded artifacts for updated snapshots
            2. Verify that UI changes are intentional
            3. If changes are correct, merge the PR to update baselines
            4. If changes are unintentional, fix the code
            
            **Files changed:**
            \`\`\`
            ${require('child_process').execSync('git diff --name-only | grep __snapshots__ || echo "No snapshot files"', {encoding: 'utf8'})}
            \`\`\`
            
            To update snapshots locally: \`npm test -- --updateSnapshot\``
          })

  user-journey:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'pnpm'

    - name: Install dependencies
      run: |
        if [ -f "pnpm-lock.yaml" ]; then
          pnpm install --frozen-lockfile || pnpm install
        else
          pnpm install
        fi

    - name: Run User Journey Tests
      run: pnpm test -- --testNamePattern="User Journey Tests" --watchAll=false --verbose --testTimeout=15000
      env:
        NODE_ENV: test
        CI: true

    - name: Generate User Journey Report
      if: always()
      run: |
        echo "## User Journey Test Results" > journey-report.md
        echo "" >> journey-report.md
        echo "### Test Categories:" >> journey-report.md
        echo "- 🛒 **Free Coffee Chat Booking Journey**: Tests complete user workflow from landing to booking" >> journey-report.md
        echo "- 🔐 **Authentication-based Journeys**: Different experiences for signed-in vs signed-out users" >> journey-report.md
        echo "- 📱 **Responsive Design Journeys**: Mobile vs desktop user experiences" >> journey-report.md
        echo "- ⚠️ **Error Handling Journeys**: Graceful degradation when APIs fail" >> journey-report.md
        echo "" >> journey-report.md
        echo "### Coverage:" >> journey-report.md
        echo "- Complete user workflows validated ✅" >> journey-report.md
        echo "- Cross-device experiences tested ✅" >> journey-report.md
        echo "- Error scenarios covered ✅" >> journey-report.md

    - name: Upload Journey Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: user-journey-report
        path: journey-report.md
        retention-days: 7
